# 前端分片上傳功能開發指南

本指南詳細說明如何在前端實作圖片分片上傳功能，並專注於細節，特別是處理網路不穩定的情況。

---

## **功能概述**

### **1. 功能需求**

- 將圖片檔案切分為多個小片段（分片）。
- 支援斷點續傳功能，網路中斷後自動恢復上傳。
- 實作上傳進度條，顯示當前進度。
- 確保數據的完整性，每片分片都需進行完整性驗證。

---

## **前端分片上傳流程**

### **1. 初始化上傳**

1. **圖片分片邏輯**：
   - 使用 `File.slice()` 方法將圖片切成固定大小的分片（如 1MB）。
   - 計算每個分片的雜湊值（如 MD5）以驗證完整性。

2. **建立上傳任務**：
   - 向伺服器發送請求，建立上傳任務並獲取任務 ID。
   - 儲存相關資訊，例如分片大小、總數量。

### **2. 上傳分片**

1. **分片上傳邏輯**：
   - 使用 `XMLHttpRequest` 或 `fetch` 逐片上傳分片資料。
   - 每次上傳請求需攜帶分片編號及雜湊值。

2. **並行上傳（可選）**：
   - 可以限制同時上傳的分片數量（如 3 個）。
   - 使用 `Promise.all()` 控制並發請求。

3. **錯誤處理**：
   - 若分片上傳失敗，應自動重試多次（如最多重試 3 次）。
   - 設定超時機制，避免長時間等待。

### **3. 監控上傳進度**

1. **進度條更新**：
   - 根據已完成的分片數量計算上傳進度：

     ```javascript
     progress = (已完成分片數 / 總分片數) * 100;
     ```

   - 使用者界面實時更新進度條。

2. **即時回饋**：
   - 提供詳細訊息，如「正在上傳第 5/10 個分片」。

### **4. 網路中斷處理**

1. **暫停上傳**：
   - 當偵測到網路中斷時，暫停所有上傳請求。
   - 將未完成的分片記錄為「待上傳」。

2. **監測網路恢復**：
   - 使用 `navigator.onLine` 或定期向伺服器發送 Ping 請求檢測網路狀態。

3. **恢復上傳**：
   - 網路恢復後，查詢伺服器已完成的分片清單。
   - 只需重新上傳未完成的分片。

### **5. 完成上傳**

1. **請求合併**：
   - 當所有分片成功上傳後，向伺服器發送請求合併。

2. **下載連結回傳**：
   - 伺服器完成合併後，返回完整圖片的下載連結或存取 URL。

---

## **技術細節與建議**

### **1. 分片大小建議**

- 分片大小應根據網路狀況設置：
  - **不穩定網路**：512KB。
  - **穩定網路**：1MB-5MB。

### **2. 並行上傳控制**

- 使用「併發請求限制」機制：
  - 利用 `Promise` 限制同時執行的請求數量。

### **3. 斷點續傳策略**

- 在每次上傳之時，向伺服器提供分片訊息，讓伺服器驗證是否重複上傳。
- 本地儲存進度，例如使用 `localStorage` 或 IndexedDB。

### **4. 安全性考量**

- 所有上傳請求應使用 HTTPS，保護資料傳輸安全。
- 每個分片請求應攜帶驗證資訊（如 Token）。
- 驗證每片雜湊值，確保資料未被竄改。

---

## **程式呼叫流程**

```mermaid
graph TD
    A[selectFile()] --> B[splitFile()]
    B --> C[createUploadTask()]
    C --> D[uploadChunk()]
    D --> E[updateProgressBar()]
    E --> F{Network Stable?}
    F -- No --> G[pauseUpload()]
    G --> H[monitorNetworkStatus()]
    H --> F
    F -- Yes --> I[resumeUpload()]
    I --> J[requestMerge()]
    J --> K[completeUpload()]
```

---

## **注意事項**

1. **處理上傳錯誤**
   - 設定合理的重試次數（例如 3 次）。
   - 錯誤日誌應儲存在本地，便於檢查問題。

2. **未完成分片清理**
   - 對於長時間未完成的上傳任務（如超過 24 小時），應由伺服器進行清理。

3. **相容性測試**
   - 測試系統在不同瀏覽器（如 Chrome、Firefox）和設備（如手機、平板）上的表現。

---

## **開發摘要**

這份指南著重於前端的分片上傳實作，提供了流程化的說明和實作細節，尤其適合需要處理大檔案和網路不穩定場景的應用程式開發。透過良好的錯誤處理與恢復機制，系統可提供更佳的用戶體驗與穩定性。

